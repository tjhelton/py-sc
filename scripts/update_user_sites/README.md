# SafetyCulture User Site Access Updater

This Python script removes user access from specific SafetyCulture sites in bulk using the SafetyCulture API's user upsert job system. It reads user emails and site IDs from a CSV file, creates an upsert job to remove site access, and validates the changes. This guide is for beginners to Python who want to run the script.

## Prerequisites
- **Python 3**: You need Python installed on your computer. Download it from [python.org](https://www.python.org/downloads/) if you don't have it.
- **pip**: This comes with Python and is used to install required libraries.
- **SafetyCulture API Token**: You need a valid API token from SafetyCulture. Replace the empty `TOKEN = ''` in the script with your token.
- **Input CSV File**: Create a CSV file named `input.csv` with user emails and site IDs.

## Setup Instructions

1. **Install Python**
   - Download and install Python 3 from [python.org](https://www.python.org/downloads/).
   - During installation, check the box to add Python to your PATH (this makes it easier to run Python from the command line).

2. **Install Required Libraries**
   - Open a terminal (Command Prompt on Windows, Terminal on macOS/Linux).
   - Run the following command to install the required Python libraries:
     ```
     pip install pandas requests
     ```
   - This installs `pandas` (for handling CSV files) and `requests` (for making API calls).

3. **Prepare the Input CSV File**
   - Create a file named `input.csv` in the same folder as the script.
   - The CSV should have `email` and `site_id` columns. For example:
     ```
     email,site_id
     john.doe@company.com,f47ac10b-58cc-4372-a567-0e02b2c3d479
     jane.smith@company.com,f47ac10b-58cc-4372-a567-0e02b2c3d480
     ```
   - Save the file as `input.csv`. You can create it in a text editor or a spreadsheet program like Excel.

4. **Add Your API Token**
   - Open the script file (e.g., `main.py`) in a text editor.
   - Find the line `TOKEN = ''` near the top.
   - Replace `''` with your SafetyCulture API token, like this:
     ```python
     TOKEN = 'your-api-token-here'
     ```
   - Save the script.

## Running the Script
1. Open a terminal and navigate to the folder containing `main.py` and `input.csv`. For example:
   ```
   cd path/to/your/folder
   ```
   (Replace `path/to/your/folder` with the actual path.)

2. Run the script by typing:
   ```
   python main.py
   ```

3. The script will:
   - Read user emails and site IDs from `input.csv`.
   - Create a user upsert job with site removal instructions.
   - Initialize and start the job with validation mode enabled.
   - Display the job results in the terminal.

## How It Works
The script uses SafetyCulture's user upsert job system to:

1. **Map CSV Data**: Converts each row into a user update instruction
2. **Create Upsert Job**: Initializes a bulk user update job
3. **Validate Changes**: Runs the job in validation mode to check for errors
4. **Display Results**: Shows the job outcome and any validation messages

The script removes users from sites by specifying:
- `"remove": [{"name": "*"}, {"id": site_id}]` - Removes access to the specific site
- `"username": email` - Identifies the user by their email address

## Output
- The script displays job results directly in the terminal
- Job ID and validation results are shown
- No CSV output file is generated by this script

## Troubleshooting
- **Error: "No module named pandas" or "No module named requests"**
  - Ensure you ran `pip install pandas requests`.
- **Error: "File input.csv not found"**
  - Make sure `input.csv` is in the same folder as the script and is correctly formatted.
- **API Errors**
  - Check that your API token is correct and valid.
  - Ensure you have permissions to manage users and site access.
  - Verify that user emails and site IDs are correct and exist in your organization.
- **Job Validation Errors**
  - The script runs in validation mode only - check the output for any validation errors
  - Common issues include invalid email addresses or non-existent site IDs
- **Permission Issues**
  - If you get permission errors, try running the terminal as an administrator (Windows) or with `sudo` (macOS/Linux).

## Important Notes
- **Validation Mode**: The script runs in validation mode (`validate_only: True`) by default
- **Site Access Removal**: This removes user access from specific sites, not all sites
- **Email Identification**: Users are identified by their email addresses
- **Bulk Processing**: All user updates are processed together in a single job
- **Job-Based System**: Uses SafetyCulture's asynchronous job system for bulk operations

## Use Cases
- **Access Control**: Remove user access from specific sites/locations
- **Organizational Changes**: Update user permissions after restructuring
- **Security Compliance**: Revoke access as part of security policies
- **Project Completion**: Remove site access when projects end
- **User Management**: Bulk update user site permissions

## Customization
To modify the script for different operations:
- Change `"remove"` to `"add"` to grant site access instead
- Modify the site specification to target different sites
- Add additional user fields to update other user properties

## Safety Considerations
- Always test with a small dataset first
- Review validation results carefully before running in production mode
- Keep your API token secure and do not share it publicly
- Ensure you have proper authorization to modify user access

For more help, consult the [SafetyCulture API documentation](https://developer.safetyculture.com/reference/usersservice_createupsertjob) or ask a colleague familiar with Python.